<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>250mesh Guardian</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- MapLibre GL JS の読み込み -->
  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <!-- Turf.js の読み込み -->
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <style>
    /* html, body に高さを指定 */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    /* 地図表示領域 */
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    /* 上部パネル */
    #topPanel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      font-family: sans-serif;
      transition: background 1s;
    }
    #topPanel button {
      margin-top: 5px;
      margin-right: 5px;
    }
    /* 残りメッシュ数表示 */
    #remaining {
      margin-top: 5px;
      font-weight: bold;
      color: #333;
    }
    /* シェアポップアップ */
    #sharePopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border: 2px solid #ccc;
      z-index: 1000;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.3);
    }
    #sharePopup button {
      margin-right: 5px;
    }
    /* オーバーレイ */
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 900;
    }
  </style>
</head>
<body>
  <!-- 上部パネル：スコア・残りメッシュ数・リセット -->
  <div id="topPanel">
    <div id="score">Score: 0</div>
    <div id="remaining">Remaining: 0</div>
    <button id="resetBtn">Reset</button>
    <div id="gameMessage" style="margin-top:5px; font-weight:bold; color:red;"></div>
  </div>
  
  <!-- 地図表示領域 -->
  <div id="map"></div>
  
  <!-- オーバーレイ（シェアポップアップ背景） -->
  <div id="overlay"></div>
  
  <!-- シェアポップアップ（ゲーム終了時に自動表示） -->
  <div id="sharePopup">
    <div id="shareMessage" style="margin-bottom: 10px;"></div>
    <button id="popupShareBtn">Share on X</button>
    <button id="popupCloseBtn">Close</button>
  </div>
  
  <script>
    /**********************
     * 背景地図設定
     **********************/
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://tile.openstreetmap.jp/styles/osm-bright/style.json',
      center: [139.6917, 35.6895],
      zoom: 10
    });
    
    /**********************
     * ゲーム用グローバル変数
     **********************/
    let municipalityData = null;
    let meshData = null;
    let score = 0;
    let gameOver = false;
    let q3Value = 0;
    let currentMunicipality = null;
    let municipalityMeshes = null;
    let safeTotal = 0;        // 安全な（高人口でない）メッシュ総数
    let safeClickedCount = 0; // クリック済みの安全メッシュ数

    /**********************
     * 表示更新関数
     **********************/
    function updateScoreDisplay() {
      document.getElementById('score').innerText = 'Score: ' + score;
    }
    function updateRemainingDisplay() {
      const remaining = safeTotal - safeClickedCount;
      document.getElementById('remaining').innerText = 'Remaining: ' + remaining;
    }

    /**********************
     * お祝いアクション
     **********************/
    function celebrate() {
      const topPanel = document.getElementById('topPanel');
      topPanel.style.background = "gold";
      setTimeout(() => {
        topPanel.style.background = "rgba(255,255,255,0.9)";
      }, 1000);
    }

    /**********************
     * シェア処理（X用）
     **********************/
    function shareOnX() {
      let message = document.getElementById("gameMessage").innerText;
      if (!message) {
        message = "250mesh Guardian: Score " + score;
      }
      const shareUrl = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(message + " #250meshGuardian");
      window.open(shareUrl, "_blank");
    }

    /**********************
     * シェアポップアップ制御
     **********************/
    function showSharePopup(message) {
      document.getElementById('shareMessage').innerText = message;
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('sharePopup').style.display = 'block';
    }
    function hideSharePopup() {
      document.getElementById('sharePopup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }
    document.getElementById('popupShareBtn').addEventListener('click', shareOnX);
    document.getElementById('popupCloseBtn').addEventListener('click', hideSharePopup);

    /**********************
     * ゲーム開始／リセット処理
     **********************/
    function startGame() {
      // 既存のカスタムレイヤーがあれば削除
      if (map.getLayer('meshes-layer')) {
        map.off('click', 'meshes-layer', handleMeshClick);
        map.removeLayer('meshes-layer');
      }
      if (map.getSource('meshes')) {
        map.removeSource('meshes');
      }
      
      gameOver = false;
      score = 0;
      safeClickedCount = 0;
      updateScoreDisplay();
      document.getElementById('gameMessage').innerText = "";
      hideSharePopup();
      
      // 自治体データからランダムに1件選択
      const features = municipalityData.features;
      currentMunicipality = features[Math.floor(Math.random() * features.length)];
      console.log("Selected municipality:", currentMunicipality.properties.name);
      
      // 自治体境界に合わせてマップ表示範囲調整
      const bbox = turf.bbox(currentMunicipality);
      map.fitBounds(bbox, { padding: 20 });
      
      // 人口データ内のメッシュから、自治体内のものを抽出（重心で判定）
      const meshesInMunicipality = meshData.features.filter(feature => {
        const centroid = turf.centroid(feature).geometry.coordinates;
        return turf.booleanPointInPolygon(centroid, currentMunicipality);
      });
      if (meshesInMunicipality.length === 0) {
        console.error("No mesh found within the selected municipality");
        return;
      }
      
      // 第3四分位数（75パーセンタイル）の計算  
      // ※ メッシュ人口は "T001142001_人口（総数）" プロパティを使用
      const populations = meshesInMunicipality.map(f => f.properties["T001142001_人口（総数）"]);
      populations.sort((a, b) => a - b);
      const q3Index = Math.floor(0.75 * populations.length);
      q3Value = populations[q3Index];
      console.log('75th percentile population:', q3Value);
      
      // 安全なメッシュ（高人口未満）の総数を算出
      safeTotal = meshesInMunicipality.filter(f => f.properties["T001142001_人口（総数）"] < q3Value).length;
      console.log('Total safe meshes:', safeTotal);
      updateRemainingDisplay();
      
      // 抽出したメッシュを GeoJSON としてまとめる
      municipalityMeshes = {
        "type": "FeatureCollection",
        "features": meshesInMunicipality
      };
      // 各メッシュに一意な id を付与（feature state 利用のため）
      municipalityMeshes.features.forEach((feature, i) => {
        feature.id = i;
      });
      
      // GeoJSON ソース追加
      map.addSource('meshes', {
        type: 'geojson',
        data: municipalityMeshes
      });
      
      // メッシュレイヤー追加（未クリックは半透明の白、クリック済みは透明）
      map.addLayer({
        id: 'meshes-layer',
        type: 'fill',
        source: 'meshes',
        layout: {},
        paint: {
          'fill-color': [
            "case",
            ["boolean", ["feature-state", "safeClicked"], false],
            "rgba(255,255,255,0)",
            "rgba(255,255,255,0.5)"
          ],
          'fill-outline-color': 'rgba(0,0,0,0.5)'
        }
      });
      
      // クリックイベントのバインド
      map.on('click', 'meshes-layer', handleMeshClick);
      map.on('mouseenter', 'meshes-layer', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'meshes-layer', () => { map.getCanvas().style.cursor = ''; });
    }

    /**********************
     * メッシュクリック時の処理
     **********************/
    function handleMeshClick(e) {
      if (gameOver) return;
      if (!e.features || e.features.length === 0) return;
      
      const clickedFeature = e.features[0];
      const state = map.getFeatureState({ source: 'meshes', id: clickedFeature.id });
      if (state && state.safeClicked) return;
      
      const pop = clickedFeature.properties["T001142001_人口（総数）"];
      console.log("Clicked mesh population:", pop);
      
      if (pop >= q3Value) {
        // 高人口メッシュをクリック → Game Over
        const remainingSafe = safeTotal - safeClickedCount;
        document.getElementById('gameMessage').innerText = 'Game Over! High population mesh clicked. Remaining: ' + remainingSafe;
        gameOver = true;
        map.off('click', 'meshes-layer', handleMeshClick);
        showSharePopup(document.getElementById('gameMessage').innerText);
      } else {
        // 安全なメッシュの場合
        map.setFeatureState({ source: 'meshes', id: clickedFeature.id }, { safeClicked: true });
        score++;
        safeClickedCount++;
        updateScoreDisplay();
        updateRemainingDisplay();
        if (safeClickedCount >= safeTotal) {
          document.getElementById('gameMessage').innerText = 'Clear!!';
          gameOver = true;
          map.off('click', 'meshes-layer', handleMeshClick);
          celebrate();
          showSharePopup(document.getElementById('gameMessage').innerText);
        }
      }
    }

    /**********************
     * リセットボタン処理
     **********************/
    document.getElementById('resetBtn').addEventListener('click', function(){
      map.off('click', 'meshes-layer', handleMeshClick);
      if (map.getLayer('meshes-layer')) { map.removeLayer('meshes-layer'); }
      if (map.getSource('meshes')) { map.removeSource('meshes'); }
      startGame();
    });

    /**********************
     * マップ読み込み後、自治体・メッシュデータ取得＆ゲーム開始
     **********************/
    map.on('load', function() {
      Promise.all([
        fetch('municipalities.geojson').then(res => res.json()),
        fetch('pop_Osakacity_yodogawku.geojson').then(res => res.json())
      ]).then(results => {
        municipalityData = results[0];
        meshData = results[1];
        startGame();
      }).catch(err => console.error("Data loading error:", err));
    });
  </script>
</body>
</html>
