<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>250mesh Guardian</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- MapLibre GL JS の読み込み -->
  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <!-- Turf.js（ジオメトリ処理用）の読み込み -->
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #topPanel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      font-family: sans-serif;
      transition: background 1s;
    }
    #topPanel button {
      margin-top: 5px;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <!-- スコア表示＆リセット・シェアボタン用パネル -->
  <div id="topPanel">
    <div id="score">Score: 0</div>
    <button id="resetBtn">Reset</button>
    <button id="shareBtn" disabled>Share on X</button>
    <div id="gameMessage" style="margin-top:5px; font-weight:bold; color:red;"></div>
  </div>
  
  <div id="map"></div>
  
  <script>
    // MapLibre の初期化（OpenStreetMap タイルスタイルを利用）
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json',
      center: [139.6917, 35.6895],
      zoom: 10
    });
    
    // GeoJSON のパス（適宜実際のパスに置き換えてください）
    const municipalityUrl = 'municipalities.geojson'; // 自治体境界の GeoJSON
    const meshDataUrl = 'pop_Osakacity_yodogawku.geojson'; // 人口データファイル
    
    // グローバル変数
    let municipalityData = null;
    let meshData = null;
    let score = 0;
    let gameOver = false;
    let q3Value = 0;
    let currentMunicipality = null;
    let municipalityMeshes = null;
    let safeTotal = 0;        // 安全な（高人口でない）メッシュ総数
    let safeClickedCount = 0; // クリック済みの安全メッシュ数
    
    // スコア表示更新
    function updateScoreDisplay() {
      document.getElementById('score').innerText = 'Score: ' + score;
    }
    
    // お祝いアクション（例：上部パネルの背景色をゴールドに一瞬変更）
    function celebrate() {
      const topPanel = document.getElementById('topPanel');
      topPanel.style.background = "gold";
      setTimeout(() => {
        topPanel.style.background = "rgba(255,255,255,0.9)";
      }, 1000);
    }
    
    // シェアボタン有効化
    function enableShareButton() {
      document.getElementById('shareBtn').disabled = false;
    }
    
    // X（旧Twitter）に投稿する処理
    function shareOnX() {
      // ゲーム結果のメッセージを取得（ゲーム終了時に設定されたもの）
      let message = document.getElementById("gameMessage").innerText;
      // ゲーム結果が設定されていない場合はスコアのみのメッセージにする
      if (!message) {
        message = "250mesh Guardian: Score " + score;
      }
      // シェア用のURLを作成
      const shareUrl = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(message + " #250meshGuardian");
      window.open(shareUrl, "_blank");
    }
    
    // ゲーム開始／リセット時の初期化処理
    function startGame() {
      // 既存のレイヤーやソースがあれば削除
      if (map.getLayer('meshes-layer')) {
        map.off('click', 'meshes-layer', handleMeshClick);
        map.removeLayer('meshes-layer');
      }
      if (map.getSource('meshes')) {
        map.removeSource('meshes');
      }
      
      // 状態初期化
      gameOver = false;
      score = 0;
      safeClickedCount = 0;
      updateScoreDisplay();
      document.getElementById('gameMessage').innerText = "";
      // シェアボタンは無効状態に
      document.getElementById('shareBtn').disabled = true;
      
      // 自治体データからランダムに１件選択
      const features = municipalityData.features;
      currentMunicipality = features[Math.floor(Math.random() * features.length)];
      console.log("選択された自治体:", currentMunicipality.properties.name);
      
      // 自治体のバウンディングボックスを計算してマップ表示範囲を調整
      const bbox = turf.bbox(currentMunicipality);
      map.fitBounds(bbox, { padding: 20 });
      
      // 人口データファイル内のメッシュのうち、自治体内のものを抽出（重心が自治体内にあるかで判定）
      const meshesInMunicipality = meshData.features.filter(feature => {
        const centroid = turf.centroid(feature).geometry.coordinates;
        return turf.booleanPointInPolygon(centroid, currentMunicipality);
      });
      
      if (meshesInMunicipality.length === 0) {
        console.error("選択された自治体内にメッシュがありません");
        return;
      }
      
      // 第３四分位数（75パーセンタイル）の計算  
      // ※ メッシュ人口はプロパティ "T001142001_人口（総数）" を使用する
      const populations = meshesInMunicipality.map(f => f.properties["T001142001_人口（総数）"]);
      populations.sort((a, b) => a - b);
      const q3Index = Math.floor(0.75 * populations.length);
      q3Value = populations[q3Index];
      console.log('第３四分位数の人口:', q3Value);
      
      // 安全なメッシュ（高人口以外）の総数を計算
      safeTotal = meshesInMunicipality.filter(f => f.properties["T001142001_人口（総数）"] < q3Value).length;
      console.log('クリック可能な安全メッシュ数:', safeTotal);
      
      // 自治体内のメッシュをまとめた GeoJSON を作成
      municipalityMeshes = {
        "type": "FeatureCollection",
        "features": meshesInMunicipality
      };
      
      // 各メッシュに一意な id を付与（feature state 利用のため）
      municipalityMeshes.features.forEach((feature, i) => {
        feature.id = i;
      });
      
      // メッシュの GeoJSON ソースを追加
      map.addSource('meshes', {
        type: 'geojson',
        data: municipalityMeshes
      });
      
      // メッシュレイヤー追加
      // fill-color は feature state "safeClicked" が true の場合に透明、それ以外は半透明の白で表示
      map.addLayer({
        id: 'meshes-layer',
        type: 'fill',
        source: 'meshes',
        layout: {},
        paint: {
          'fill-color': [
            "case",
            ["boolean", ["feature-state", "safeClicked"], false],
            "rgba(255,255,255,0)",  // 安全クリック済みの場合は塗りつぶしなし（枠線のみ）
            "rgba(255,255,255,0.5)" // 初期状態は半透明の白
          ],
          'fill-outline-color': 'rgba(0,0,0,0.5)'
        }
      });
      
      // メッシュクリック時のイベントバインド
      map.on('click', 'meshes-layer', handleMeshClick);
      
      // マウスオーバー時はカーソルをポインターに変更
      map.on('mouseenter', 'meshes-layer', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'meshes-layer', () => {
        map.getCanvas().style.cursor = '';
      });
    }
    
    // メッシュクリック時の処理
    function handleMeshClick(e) {
      if (gameOver) return;  // ゲーム終了時はクリック無視
      if (!e.features || e.features.length === 0) return;
      
      const clickedFeature = e.features[0];
      // すでに安全クリック済みなら何もしない
      const state = map.getFeatureState({ source: 'meshes', id: clickedFeature.id });
      if (state && state.safeClicked) return;
      
      // ※ メッシュ人口は "T001142001_人口（総数）" プロパティを使用する
      const pop = clickedFeature.properties["T001142001_人口（総数）"];
      console.log("クリックされたメッシュの人口:", pop);
      
      // 高人口（第３四分位数以上）の場合 → Game Over
      if (pop >= q3Value) {
        const remainingSafe = safeTotal - safeClickedCount;
        document.getElementById('gameMessage').innerText = 
          'Game Over! 高人口メッシュをクリックしました。残りのクリック可能な安全メッシュ数: ' + remainingSafe;
        gameOver = true;
        // クリックイベントを解除
        map.off('click', 'meshes-layer', handleMeshClick);
        // シェアボタンを有効化
        enableShareButton();
      } else {
        // 安全なメッシュの場合
        map.setFeatureState({ source: 'meshes', id: clickedFeature.id }, { safeClicked: true });
        score++;
        safeClickedCount++;
        updateScoreDisplay();
        
        // すべての安全メッシュがクリックされた場合 → クリア
        if (safeClickedCount >= safeTotal) {
          document.getElementById('gameMessage').innerText = 'Clear!!';
          gameOver = true;
          map.off('click', 'meshes-layer', handleMeshClick);
          // お祝いのアクション
          celebrate();
          // シェアボタンを有効化
          enableShareButton();
        }
      }
    }
    
    // リセットボタンのクリック処理
    document.getElementById('resetBtn').addEventListener('click', () => {
      // 既存のイベント解除、レイヤー・ソース削除後に再初期化
      map.off('click', 'meshes-layer', handleMeshClick);
      if (map.getLayer('meshes-layer')) {
        map.removeLayer('meshes-layer');
      }
      if (map.getSource('meshes')) {
        map.removeSource('meshes');
      }
      startGame();
    });
    
    // シェアボタンのクリック処理
    document.getElementById('shareBtn').addEventListener('click', shareOnX);
    
    // マップ読み込み後、自治体・メッシュデータを取得してゲーム開始
    map.on('load', function() {
      Promise.all([
        fetch(municipalityUrl).then(res => res.json()),
        fetch(meshDataUrl).then(res => res.json())
      ]).then(results => {
        municipalityData = results[0];
        meshData = results[1];
        startGame();
      }).catch(err => console.error("データ読み込みエラー:", err));
    });
  </script>
</body>
</html>
